# ⏰ 本地定时任务 - 开机补运行说明

## 🎯 工作原理

现在有**两个任务**协同工作：

### 1️⃣ 主定时任务（8:05运行）
```
每天早上8:05 → 自动生成简报
```

### 2️⃣ 开机检查任务（开机后运行）
```
开机后 → 检查今日简报是否存在
   ├─ 存在 → 跳过
   └─ 不存在 + 8:00-12:00 → 立即生成
```

---

## 📋 各种场景

### 场景1：正常情况（电脑8:05已开机）

```
8:05 AM → 主任务运行 → 生成简报 ✅
开机后 → 开机检查任务 → 发现已存在 → 跳过 ✅
```

### 场景2：电脑8:05关机，9:00开机

```
8:05 AM → 主任务未运行（电脑关机）❌
9:00 AM → 开机 → 开机检查任务 → 检测到错过 → 立即生成 ✅
```

### 场景3：电脑全天关机，晚上8:00才开机

```
8:05 AM → 主任务未运行（关机）❌
20:00 PM → 开机 → 开机检查任务 → 时间已过(>12:00) → 跳过 ⏸️
```
**结果：今天没有简报，等待明天**

### 场景4：多次开关机

```
第一次开机 → 开机检查 → 生成简报 ✅
第二次开机 → 开机检查 → 发现已存在 → 跳过 ✅
```

---

## 🛡️ 智能保护机制

### 1. 避免重复生成

```python
# 检查文件是否存在
if [ -f "output/archive/$TODAY.md" ]; then
    echo "今日简报已存在，跳过"
    exit 0
fi
```

### 2. 时间范围判断

```bash
# 只在6:00-23:59之间运行
if [ "$NOW_HOUR" -lt 6 ] || [ "$NOW_HOUR" -ge 23 ]; then
    echo "时间不适宜，等待定时任务"
    exit 0
fi
```

### 3. 紫色主题检查

```bash
# 安全推送脚本会检查
if ! grep -q "667eea" "$TODAY.html"; then
    echo "错误：不是紫色主题！"
    exit 1
fi
```

---

## 📊 运行概率

| 时间段 | 电脑状态 | 行为 |
|--------|---------|------|
| 8:00-9:00 | 开机 | 8:05主任务运行，开机检查跳过 |
| 9:00-12:00 | 开机 | 开机检查立即生成（补运行） |
| 12:00-23:00 | 开机 | 等待明天 |
| 任意时间 | 关机 | 等待下次开机 |
| 凌晨/深夜 | 开机 | 等待6:00后 |

---

## 🧪 测试方法

### 测试1：正常定时运行

```bash
# 等待明天早上8:05，或手动触发
./scripts/auto_generate_and_push.sh
```

### 测试2：开机补运行

```bash
# 删除今日简报（模拟未生成）
rm -f output/archive/2026-01-25.md

# 模拟开机运行
./scripts/boot_check.sh
```

### 测试3：查看日志

```bash
# 开机检查日志
cat logs/boot-$(date +%Y%m%d).log

# 主任务日志
cat logs/auto-$(date +%Y%m%d).log

# 所有任务状态
launchctl list | grep legalnews
```

---

## 🔧 修改配置

### 修改主任务时间

编辑 `com.legalnews.daily.plist`：

```xml
<!-- 改为早上9点 -->
<key>StartHour</key>
<integer>9</integer>

<!-- 改为9:05 -->
<key>StartMinute</key>
<integer>5</integer>
```

然后重新加载：
```bash
./update_launchd.sh
```

### 修改开机检查逻辑

编辑 `scripts/boot_check.sh`：

```bash
# 只在8:00-10:00补运行
if [ "$NOW_HOUR" -ge 8 ] && [ "$NOW_HOUR" -lt 10 ]; then
    # 补运行代码
fi
```

---

## 📱 系统通知

成功/失败时会收到macOS通知：

- 🔄 "开机补运行成功"
- ✅ "生成成功"
- ❌ "推送失败"

---

## 🎯 总结

**最可靠的方式：**

1. ✅ **理想情况**：8:05电脑开机 → 主任务运行
2. ✅ **错过了8:05**：9:00开机 → 补运行
3. ✅ **长时间关机**：等待明天
4. ✅ **多次开关机**：只生成一次（智能判断）

**完全自动化，无需人工干预！** 🎉
